services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    user: "${CDX_WEB_SCAN_UID:-1000}:${CDX_WEB_SCAN_GID:-1000}"
    environment:
      # Flask config selector (required; used by cdx_web_scan/__init__.py)
      APP_MODE: config.ProdConfig
      APP_SERVER_OS: Linux

      # Required for sessions
      SECRET_KEY: ${SECRET_KEY}

      # Persist DB + logs to /data (mounted volume below)
      CDX_WEB_SCAN_FOLDER: /data
      CDX_WEB_SCAN_DB_FILE_NAME: cdx_web_scan.sqlite
      CDX_WEB_SCAN_LOG_FILE: /data/cdx_web_scan.log

      # Intake API
      INTAKE_API_URL: ${INTAKE_API_URL}
      INTAKE_API_TOKEN: ${INTAKE_API_TOKEN}

    volumes:
      # Bind-mount host folder to persist SQLite DB + logs outside Docker
      - ${CDX_WEB_SCAN_HOST_DATA_DIR:-./cdx_data}:/data

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      - app
    ports:
      - "8080:80"
      - "443:443"
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./deploy/certs:/etc/nginx/certs:ro

 
