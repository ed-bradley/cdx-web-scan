services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # Flask config selector (required; used by cdx_web_scan/__init__.py)
      APP_MODE: config.ProdConfig
      APP_SERVER_OS: Linux

      # Required for sessions
      SECRET_KEY: ${SECRET_KEY}

      # Persist DB + logs to /data (mounted volume below)
      CDX_WEB_SCAN_FOLDER: /data
      CDX_WEB_SCAN_DB_FILE_NAME: cdx_web_scan.sqlite
      CDX_WEB_SCAN_LOG_FILE: /data/cdx_web_scan.log

      # Intake API
      INTAKE_API_URL: ${INTAKE_API_URL}
      INTAKE_API_TOKEN: ${INTAKE_API_TOKEN}

    volumes:
      - cdx_data:/data

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      - app
    ports:
      - "80:80"
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  cdx_data:
